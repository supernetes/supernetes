# This is self-hosted Renovate: we can't use the Mend-hosted one, since we need to be able to run `make tidy` in
# `postUpgradeTasks` to both generate the Protobuf artifacts and sync dependency updates across the components.
# This remains a paid feature for the hosted version, and an absent feature in Dependabot.

on:
  schedule:
    # Run passes every 15 minutes on Mondays between 15:00 and 16:00. We need to trigger this workflow
    # multiple times, as Renovate will only auto-merge one branch/PR, per target branch, per run:
    # https://docs.renovatebot.com/key-concepts/automerge/#renovate-automerges-take-time
    - cron: "0/15 15 * * 1"
  workflow_dispatch: # Manual invocation option

name: Renovate
jobs:
  renovate:
    name: Dependencies
    runs-on: ubuntu-24.04
    steps:
      - name: Check out sources
        uses: actions/checkout@v5
      - name: Use Docker in rootless mode
        uses: ScribeMD/rootless-docker@0.2.2
      - name: Source environment
        run: echo XDG_RUNTIME_DIR="$XDG_RUNTIME_DIR" >> "$GITHUB_ENV"
      - name: Run Renovate
        uses: renovatebot/github-action@v43.0.10
        with:
          configurationFile: .github/renovate-custom.json5
          docker-user: root # We're running rootless
          mount-docker-socket: true # Required for `make tidy` inside the Renovate container
          docker-socket-host-path: ${{ env.XDG_RUNTIME_DIR }}/docker.sock # Rootless Docker socket
          token: ${{ secrets.RENOVATE_TOKEN }}
        env:
          RENOVATE_GIT_PRIVATE_KEY: ${{ secrets.RENOVATE_GIT_PRIVATE_KEY }}
